name: CI

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Resolve Unity Path
        id: unity
        shell: pwsh
        env:
          UNITY_PATH_SECRET: ${{ secrets.UNITY_PATH }}
        run: |
          $candidates = @()
          if ($env:UNITY_PATH_SECRET) { $candidates += $env:UNITY_PATH_SECRET }
          $candidates += @(
            "C:\Program Files\Unity\Hub\Editor\2022.3.62f3\Editor\Unity.exe",
            "C:\Program Files\Unity\Hub\Editor\2022.3.62f3-x86_64\Editor\Unity.exe"
          )
          $resolved = $candidates | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1
          if ($resolved) {
            "UNITY_PATH=$resolved" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "unity_available=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "Unity path resolved." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          } else {
            "UNITY_PATH=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "unity_available=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "Unity not available on this runner. Unity-dependent steps were skipped." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }

      - name: Check
        shell: pwsh
        run: .\scripts\check.ps1

      - name: Test
        if: ${{ steps.unity.outputs.unity_available == 'true' }}
        shell: pwsh
        run: .\scripts\test.ps1

      - name: Build Client
        if: ${{ steps.unity.outputs.unity_available == 'true' }}
        shell: pwsh
        run: .\scripts\build-client.ps1

      - name: Build Server
        if: ${{ steps.unity.outputs.unity_available == 'true' }}
        shell: pwsh
        run: .\scripts\build-server.ps1

      - name: Unity Steps Skipped Notice
        if: ${{ steps.unity.outputs.unity_available != 'true' }}
        shell: pwsh
        run: Write-Host "Unity-dependent CI steps were skipped."

  mobile-gate:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Resolve Unity Path
        id: unity
        shell: pwsh
        env:
          UNITY_PATH_SECRET: ${{ secrets.UNITY_PATH }}
        run: |
          $candidates = @()
          if ($env:UNITY_PATH_SECRET) { $candidates += $env:UNITY_PATH_SECRET }
          $candidates += @(
            "C:\Program Files\Unity\Hub\Editor\2022.3.62f3\Editor\Unity.exe",
            "C:\Program Files\Unity\Hub\Editor\2022.3.62f3-x86_64\Editor\Unity.exe"
          )
          $resolved = $candidates | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1
          if ($resolved) {
            "UNITY_PATH=$resolved" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "unity_available=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "Unity path resolved." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          } else {
            "UNITY_PATH=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "unity_available=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "Unity not available on this runner. Mobile gate steps were skipped." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }

      - name: Unity Steps Skipped Notice
        if: ${{ steps.unity.outputs.unity_available != 'true' }}
        shell: pwsh
        run: Write-Host "Mobile gate Unity steps were skipped."

      - name: Build Android
        if: ${{ steps.unity.outputs.unity_available == 'true' }}
        shell: pwsh
        run: .\scripts\build-android.ps1

      - name: Smoke Mobile
        if: ${{ steps.unity.outputs.unity_available == 'true' }}
        shell: pwsh
        run: .\scripts\smoke-mobile.ps1

      - name: Upload Mobile Logs
        if: ${{ always() && steps.unity.outputs.unity_available == 'true' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: mobile-logs-${{ github.run_id }}
          path: |
            logs/build_android_*.log
            logs/build_android_results_*.log
            logs/unity-build-android*.log
            logs/smoke_mobile_*.log
            logs/smoke_mobile_results_*.log
            logs/unity-smoke-mobile*.log
          if-no-files-found: warn
          retention-days: 14

      - name: Upload Android APK
        if: ${{ always() && steps.unity.outputs.unity_available == 'true' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: android-apk-${{ github.run_id }}
          path: artifacts/builds/android/MinigameClient.apk
          if-no-files-found: warn
          retention-days: 14

