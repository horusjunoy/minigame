name: Unity Mobile Gate

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
  workflow_dispatch:

concurrency:
  group: unity-mobile-gate-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  unity-mobile-gate:
    if: ${{ vars.UNITY_CI_ENABLED == 'true' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository) }}
    timeout-minutes: 70
    runs-on:
      - self-hosted
      - Windows
      - X64
      - unity
    steps:
      - name: Runner Preflight Cleanup
        shell: pwsh
        run: |
          $repoDir = "C:\ci\minigame"
          $lockPath = Join-Path $repoDir "Temp\UnityLockfile"
          $targets = @(
            "Unity",
            "UnityCrashHandler64",
            "Unity.ILPP.Runner",
            "UnityPackageManager",
            "UnityShaderCompiler",
            "UnityAutoQuitter"
          )
          foreach ($name in $targets) {
            Get-Process -Name $name -ErrorAction SilentlyContinue | ForEach-Object {
              try { Stop-Process -Id $_.Id -Force -ErrorAction SilentlyContinue } catch {}
            }
          }
          Remove-Item $lockPath -ErrorAction SilentlyContinue

      - name: Prepare Persistent Workspace
        shell: pwsh
        env:
          REPO_URL: https://github.com/${{ github.repository }}.git
        run: |
          $repoDir = "C:\ci\minigame"
          if (-not (Test-Path (Join-Path $repoDir ".git"))) {
            if (-not (Test-Path "C:\ci")) { New-Item -ItemType Directory -Path "C:\ci" | Out-Null }
            git clone --depth 1 $env:REPO_URL $repoDir
          }
          Set-Location $repoDir
          git fetch --prune origin
          if ($env:GITHUB_EVENT_NAME -eq "pull_request") {
            git fetch origin $env:GITHUB_SHA
            git reset --hard FETCH_HEAD
          } else {
            git fetch origin master
            git reset --hard origin/master
          }
          "REPO_DIR=$repoDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Validate Unity Path
        shell: pwsh
        env:
          UNITY_PATH_SECRET: ${{ secrets.UNITY_PATH }}
        run: |
          if (-not $env:UNITY_PATH_SECRET) {
            Write-Error "UNITY_PATH secret not set."
            exit 1
          }
          if (-not (Test-Path $env:UNITY_PATH_SECRET)) {
            Write-Error "UNITY_PATH not found on runner: $env:UNITY_PATH_SECRET"
            exit 1
          }
          "UNITY_PATH=$env:UNITY_PATH_SECRET" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "UNITY_PATH resolved from repository secret." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Build Android
        shell: pwsh
        working-directory: ${{ env.REPO_DIR }}
        run: .\scripts\build-android.ps1 -TimeoutSeconds 1200

      - name: Smoke Mobile
        shell: pwsh
        working-directory: ${{ env.REPO_DIR }}
        run: .\scripts\smoke-mobile.ps1

      - name: Upload Mobile Logs
        if: ${{ failure() || cancelled() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: unity-mobile-logs-${{ github.run_id }}
          path: |
            ${{ env.REPO_DIR }}\logs\build_android_*.log
            ${{ env.REPO_DIR }}\logs\build_android_results_*.log
            ${{ env.REPO_DIR }}\logs\unity-build-android*.log
            ${{ env.REPO_DIR }}\logs\smoke_mobile_*.log
            ${{ env.REPO_DIR }}\logs\smoke_mobile_results_*.log
            ${{ env.REPO_DIR }}\logs\unity-smoke-mobile*.log
          if-no-files-found: warn
          retention-days: 14

      - name: Upload Android APK
        if: ${{ failure() || cancelled() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: unity-android-apk-${{ github.run_id }}
          path: ${{ env.REPO_DIR }}\artifacts\builds\android\MinigameClient.apk
          if-no-files-found: warn
          retention-days: 14

      - name: Runner Post Cleanup
        if: always()
        shell: pwsh
        run: |
          $repoDir = "C:\ci\minigame"
          $lockPath = Join-Path $repoDir "Temp\UnityLockfile"
          $targets = @(
            "Unity",
            "UnityCrashHandler64",
            "Unity.ILPP.Runner",
            "UnityPackageManager",
            "UnityShaderCompiler",
            "UnityAutoQuitter"
          )
          foreach ($name in $targets) {
            Get-Process -Name $name -ErrorAction SilentlyContinue | ForEach-Object {
              try { Stop-Process -Id $_.Id -Force -ErrorAction SilentlyContinue } catch {}
            }
          }
          Remove-Item $lockPath -ErrorAction SilentlyContinue

  unity-mobile-gate-disabled:
    if: ${{ vars.UNITY_CI_ENABLED != 'true' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository) }}
    runs-on: windows-latest
    steps:
      - name: Disabled Notice
        shell: pwsh
        run: |
          "Unity Mobile Gate is disabled. Set repository variable UNITY_CI_ENABLED=true and provide a self-hosted runner with labels [self-hosted, windows, unity]." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          Write-Host "Unity Mobile Gate disabled."

